<main class="lg:max-w-305 mx-auto">
  <div class="flex flex-col lg:flex-row md:gap-x-20 mb-4 md:mb-8">
    <dl
      class="flex justify-center md:justify-start md:max-w-121.25 mb-4 gap-x-5 md:gap-x-4 md:mb-5 lg:items-center lg:mb-0"
    >
      <!-- WPM -->
      <tst-metrics-data class="flex-1 md:flex-none" dataTitle="WPM" dataValue="{{ wpm() }}" />

      <ng-container [ngTemplateOutlet]="verticalSeparator" />

      <!-- Accuracy -->
      <tst-metrics-data
        class="flex-1 md:flex-none"
        dataTitle="Accuracy"
        dataValue="{{ accuracy() }}%"
        [dataIsRed]="accuracy() !== 100 && accuracy() !== 0"
      />

      <ng-container [ngTemplateOutlet]="verticalSeparator" />

      <!-- Time -->
      <tst-metrics-data
        class="flex-1 md:flex-none"
        dataTitle="Time"
        dataValue="{{ time() }}"
        [dataIsYellow]="(testStarted$ | async) || undefined"
      />
    </dl>

    <form class="gap-x-4 md:flex md:items-center" #settingsForm="ngForm">
      <div class="grid grid-cols-2 md:hidden gap-x-2.5">
        <button
          data-tstSettingsOption
          [active]="false"
          type="button"
          popovertarget="difficulty-popover"
        >
          {{ difficultyLabel() }}

          <img
            src="/images/icon-down-arrow.svg"
            alt=""
            aria-hidden="true"
            class="transition-all duration-300"
            [class.rotate-180]="difficultyPopoverOpen()"
          />
        </button>

        <div
          id="difficulty-popover"
          class="settings-popover bg-transparent open:grid rounded-lg"
          popover
          (toggle)="onDifficultyPopoverToggle($event)"
        >
          @for(option of difficultyOptions; track option.id) {
          <div class="bg-neutral-800 p-2.5 border-b last:border-b-0 border-neutral-700">
            <input
              [attr.id]="option.id + '-mobile'"
              type="radio"
              name="difficulty-mobile"
              [(ngModel)]="difficulty"
              [value]="option.value"
            />

            <label [attr.for]="option.id + '-mobile'" class="text-neutral-0 cursor-pointer">
              {{ option.label }}
            </label>
          </div>
          }
        </div>

        <button data-tstSettingsOption [active]="false" type="button" popovertarget="mode-popover">
          {{ modeLabel() }}

          <img
            src="/images/icon-down-arrow.svg"
            alt=""
            aria-hidden="true"
            class="transition-all duration-300"
            [class.rotate-180]="modePopoverOpen()"
          />
        </button>

        <div
          id="mode-popover"
          class="settings-popover bg-transparent open:grid rounded-lg"
          popover
          (toggle)="onModePopoverToggle($event)"
        >
          @for(option of modeOptions; track option.id) {
          <div class="bg-neutral-800 p-2.5 border-b last:border-b-0 border-neutral-700">
            <input
              [attr.id]="option.id + '-mobile'"
              type="radio"
              name="mode-mobile"
              [(ngModel)]="mode"
              [value]="option.value"
            />

            <label [attr.for]="option.id + '-mobile'" class="text-neutral-0 cursor-pointer">
              {{ option.label }}
            </label>
          </div>
          }
        </div>
      </div>

      <fieldset class="hidden md:block">
        <div class="flex items-center gap-x-2">
          <legend class="text-neutral-400">Difficulty:</legend>

          <div class="flex gap-x-1.5">
            @for(option of difficultyOptions; track option.id) {
            <div>
              <label
                data-tstSettingsOption
                [active]="difficulty === option.value"
                [attr.for]="option.id"
                >{{ option.label }}</label
              >
              <input
                type="radio"
                name="difficulty"
                [attr.id]="option.id"
                [(ngModel)]="difficulty"
                [value]="option.value"
                class="sr-only"
                tabindex="-1"
              />
            </div>
            }
          </div>
        </div>
      </fieldset>

      <ng-container class="hidden md:block" [ngTemplateOutlet]="verticalSeparator" />

      <fieldset class="hidden md:block">
        <div class="flex items-center gap-x-2">
          <legend class="text-neutral-400">Mode:</legend>

          <div class="flex gap-x-1.5">
            @for(option of modeOptions; track option.id) {
            <div>
              <label
                data-tstSettingsOption
                [active]="mode === option.value"
                [attr.for]="option.id"
                >{{ option.label }}</label
              >
              <input
                type="radio"
                name="mode"
                [attr.id]="option.id"
                [(ngModel)]="mode"
                [value]="option.value"
                class="sr-only"
                tabindex="-1"
              />
            </div>
            }
          </div>
        </div>
      </fieldset>
    </form>
  </div>

  <hr class="border-neutral-700 mb-8 md:hidden" aria-hidden="true" />

  <div class="relative mb-14 md:mb-24">
    <div class="text-[2rem]/[136%] sm:text-[2.5rem]/[136%]">
      @for(char of testText$ | async; track $index; let i = $index) {
      <span
        class="rounded-sm px-px relative"
        [class]="{
          'text-neutral-400': char.state === 'PENDING',
          'text-green-500': char.state === 'CORRECT',
          'text-red-500': char.state === 'INCORRECT',
          'wrong-character': char.state === 'INCORRECT',
        }"
        [class.bg-neutral-600]="(cursorPosition$ | async) === i && (testStarted$ | async)"
        >{{ char.value }}</span
      >
      }
    </div>

    <div
      [class.grid]="!(testStarted$ | async)"
      [class.hidden]="testStarted$ | async"
      class="absolute inset-0 w-full grid place-items-center backdrop-blur-sm"
    >
      <div class="text-center">
        <button data-tstButton class="start-button cursor-pointer" (click)="onStartChallenge()">
          Start Typing Test
        </button>
        <p class="font-semibold text-xl mt-5">Or click the text and start typing</p>
      </div>
    </div>
  </div>

  <div
    [class.block]="testStarted$ | async"
    [class.hidden]="!(testStarted$ | async)"
    class="text-center"
  >
    <button data-tstButton [variant]="'tertiary'" (click)="onRestartChallenge(difficulty)">
      Restart Test
      <img class="text-red-500" src="/images/icon-restart-light.svg" alt="" aria-hidden="true" />
    </button>
  </div>
</main>

<ng-template #verticalSeparator>
  <div class="w-px bg-neutral-700 md:h-6" aria-hidden="true"></div>
</ng-template>
